<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Estateicons AI Campaign Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #4361ee;
        --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      body {
        background: var(--bg-gradient);
        font-family: "Segoe UI", system-ui;
        color: #2b2d42;
      }
      .gradient-text {
        background: linear-gradient(90deg, #4361ee, #facc15);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .nav-glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: var(--card-shadow);
        border-radius: 12px;
        padding: 0.5rem 1rem;
        margin-bottom: 2rem;
      }
      .dashboard-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 1rem;
      }
      .data-table {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        overflow: hidden;
      }
      .data-table th {
        background: var(--primary-color);
        color: white;
        font-weight: 500;
      }
      .action-btn {
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .chart-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
      }
      .modal-glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      /* Campaign Script Box styling */
      .campaign-script-box {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff;
      }
      .campaign-script-box h5 {
        font-weight: 600;
        color: var(--primary-color);
      }
      .campaign-script-box p {
        margin-bottom: 0.5rem;
      }
      /* Toast style */
      #toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        min-width: 250px;
        background-color: #4361ee;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      #toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <!-- Header -->
      <header class="mb-5 text-center">
        <h1 class="display-5 fw-bold gradient-text">
          <i class="fas fa-rocket me-2"></i>Estateicons AI Campaign Manager
        </h1>
        <p class="lead text-muted">Advanced Advertising Management Platform</p>
        <? if (userEmail) { ?>
          <p class="small">Welcome, <?= userEmail ?>!</p>
        <? } ?>
      </header>
      
      <!-- Navigation Tabs -->
      <ul class="nav nav-pills nav-glass mb-4" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#campaigns" type="button">
            Campaigns
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#adsets" type="button">
            Ad Sets
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#ads" type="button">
            Ads
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#upload" type="button">
            Upload CSV
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#analysis" type="button">
            Analysis
          </button>
        </li>
        <!-- Campaign Scripts Tab -->
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#campaignScripts" type="button">
            Campaign Scripts
          </button>
        </li>
      </ul>
      
      <!-- Tab Contents -->
      <div class="tab-content">
        <!-- Campaigns Tab -->
        <div class="tab-pane fade show active" id="campaigns" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <button class="btn btn-primary action-btn" onclick="loadCampaigns()">
                <i class="fas fa-sync me-2"></i>Refresh
              </button>
              <button class="btn btn-success action-btn" onclick="showAddCampaignModal()">
                <i class="fas fa-plus me-2"></i>New Campaign
              </button>
            </div>
            <div class="w-25 position-relative">
              <input type="search" id="searchCampaigns" class="form-control ps-5" placeholder="Search Campaigns...">
              <i class="fas fa-search position-absolute" style="left:10px; top:50%; transform: translateY(-50%); color:#6c757d;"></i>
            </div>
          </div>
          <div class="table-responsive">
            <div id="campaignsContainer"></div>
          </div>
        </div>
        
        <!-- Ad Sets Tab -->
        <div class="tab-pane fade" id="adsets" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <button class="btn btn-primary action-btn" onclick="loadAdSets()">
                <i class="fas fa-sync me-2"></i>Refresh
              </button>
              <button class="btn btn-success action-btn" onclick="showAddAdSetModal()">
                <i class="fas fa-plus me-2"></i>New Ad Set
              </button>
            </div>
            <div class="w-25 position-relative">
              <input type="search" id="searchAdSets" class="form-control ps-5" placeholder="Search Ad Sets...">
              <i class="fas fa-search position-absolute" style="left:10px; top:50%; transform: translateY(-50%); color:#6c757d;"></i>
            </div>
          </div>
          <div class="table-responsive">
            <div id="adSetsContainer"></div>
          </div>
        </div>
        
        <!-- Ads Tab -->
        <div class="tab-pane fade" id="ads" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <button class="btn btn-primary action-btn" onclick="loadAds()">
                <i class="fas fa-sync me-2"></i>Refresh
              </button>
              <button class="btn btn-success action-btn" onclick="showAddAdModal()">
                <i class="fas fa-plus me-2"></i>New Ad
              </button>
            </div>
            <div class="w-25 position-relative">
              <input type="search" id="searchAds" class="form-control ps-5" placeholder="Search Ads...">
              <i class="fas fa-search position-absolute" style="left:10px; top:50%; transform: translateY(-50%); color:#6c757d;"></i>
            </div>
          </div>
          <div class="table-responsive">
            <div id="adsContainer"></div>
          </div>
        </div>
        
        <!-- Upload CSV Tab -->
        <div class="tab-pane fade" id="upload" role="tabpanel">
          <div class="text-center mb-4">
            <h4>Upload CSV File</h4>
            <select id="csvType" class="form-select mb-2" style="width:200px; margin:0 auto;">
              <option value="campaigns">Campaigns</option>
              <option value="adsets">Ad Sets</option>
              <option value="ads">Ads</option>
            </select>
            <input type="file" id="fileUpload" accept=".csv" class="form-control">
            <button class="btn btn-primary action-btn mt-2" onclick="uploadFile()">
              <i class="fas fa-upload me-2"></i>Upload File
            </button>
            <div id="uploadStatus" class="mt-2"></div>
          </div>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tab-pane fade" id="analysis" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Analysis Dashboard</h4>
            <button class="btn btn-primary" onclick="loadAnalysis()">
              <i class="fas fa-play me-2"></i>Run Complete Analysis
            </button>
          </div>
          <div class="row g-4">
            <!-- Campaigns Card -->
            <div class="col-md-4">
              <div class="dashboard-card">
                <h5>Campaigns</h5>
                <p><strong>Total Budget:</strong> <span id="totalBudget">€0</span></p>
                <p><strong>Total Conversions:</strong> <span id="totalConversions">0</span></p>
                <p><strong>Avg CTR:</strong> <span id="avgCTR">0%</span></p>
                <p><strong>Avg CPA:</strong> <span id="avgCPA">0</span></p>
                <p><strong>Avg ROAS:</strong> <span id="avgROAS">0</span></p>
                <p><strong>Conversion Rate:</strong> <span id="conversionRate">0%</span></p>
                <p id="campaignSuggestion" class="small text-muted"></p>
              </div>
            </div>
            <!-- Ad Sets Card -->
            <div class="col-md-4">
              <div class="dashboard-card">
                <h5>Ad Sets</h5>
                <p><strong>Total Budget:</strong> <span id="adSetTotalBudget">€0</span></p>
                <p><strong>Avg Budget:</strong> <span id="adSetAvgBudget">0</span></p>
                <p><strong>Avg Daily Budget:</strong> <span id="adSetAvgDailyBudget">0</span></p>
                <p id="adSetSuggestion" class="small text-muted"></p>
              </div>
            </div>
            <!-- Ads Card -->
            <div class="col-md-4">
              <div class="dashboard-card">
                <h5>Ads</h5>
                <p><strong>Total Clicks:</strong> <span id="adsTotalClicks">0</span></p>
                <p><strong>Total Conversions:</strong> <span id="adsTotalConversions">0</span></p>
                <p><strong>Avg CTR:</strong> <span id="adsAvgCTR">0%</span></p>
                <p><strong>Avg Engagement:</strong> <span id="adsAvgEngagement">0%</span></p>
                <p><strong>Conversion Rate:</strong> <span id="adsConversionRate">0%</span></p>
                <p id="adsSuggestion" class="small text-muted"></p>
              </div>
            </div>
          </div>
          <!-- Charts -->
          <div class="row g-4 mt-4">
            <div class="col-md-6">
              <div class="chart-container">
                <h5 class="mb-3">Campaign KPIs</h5>
                <canvas id="campaignChart"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="chart-container">
                <h5 class="mb-3">Ads Performance</h5>
                <canvas id="adsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Campaign Scripts Tab -->
        <div class="tab-pane fade" id="campaignScripts" role="tabpanel">
          <div class="mb-4">
            <h4>Campaign Scripts</h4>
            <p class="text-muted">Below you can view and copy the preformatted campaign scripts for Facebook Ads Manager.</p>
            <div id="campaignScriptsContainer"></div>
            <button class="btn btn-primary mt-2" onclick="copyAllCampaignScripts()">Copy All Scripts</button>
          </div>
          <hr>
          <!-- AI Generation Form for Textual Campaign Script -->
          <div class="dashboard-card p-3 mb-4">
            <h4>Generate AI Campaign Script</h4>
            <div class="mb-3">
              <label class="form-label">Campaign Type</label>
              <select id="campaignTypeAI" class="form-select">
                <option value="Lead Generation">Lead Generation</option>
                <option value="Retargeting">Retargeting</option>
                <option value="Brand Awareness">Brand Awareness</option>
                <option value="Special Offers">Special Offers</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">City</label>
              <input type="text" id="city" class="form-control" placeholder="e.g., Miami, FL">
            </div>
            <div class="mb-3">
              <label class="form-label">Budget (USD)</label>
              <input type="number" id="budget" class="form-control" placeholder="e.g., 500">
            </div>
            <div class="mb-3">
              <label class="form-label">Agent Name</label>
              <input type="text" id="agentName" class="form-control" placeholder="e.g., John Doe">
            </div>
            <div class="mb-3">
              <label class="form-label">Tone</label>
              <select id="tone" class="form-select">
                <option value="Persuasive">Persuasive</option>
                <option value="Informative">Informative</option>
                <option value="Friendly">Friendly</option>
              </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateAICampaignScript()">Generate AI Campaign Script</button>
            <div id="aiCampaignOutput" class="campaign-script-box mt-3"></div>
          </div>
          
          <!-- AI Generation Form for Video Campaign Script -->
          <div class="dashboard-card p-3">
            <h4>Generate Video Campaign Script with AI</h4>
            <div class="mb-3">
              <label class="form-label">Video Type</label>
              <select id="videoType" class="form-select">
                <option value="Property Tour">Property Tour</option>
                <option value="Client Testimonial">Client Testimonial</option>
                <option value="Agent Introduction">Agent Introduction</option>
                <option value="Virtual Open House">Virtual Open House</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">City</label>
              <input type="text" id="videoCity" class="form-control" placeholder="e.g., New York, NY">
            </div>
            <div class="mb-3">
              <label class="form-label">Agent Name</label>
              <input type="text" id="videoAgentName" class="form-control" placeholder="e.g., Jane Smith">
            </div>
            <div class="mb-3">
              <label class="form-label">Tone</label>
              <select id="videoTone" class="form-select">
                <option value="Dynamic">Dynamic</option>
                <option value="Professional">Professional</option>
                <option value="Friendly">Friendly</option>
              </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateVideoScript()">Generate Video Campaign Script</button>
            <div id="videoCampaignOutput" class="campaign-script-box mt-3"></div>
            <button class="btn btn-success w-100 mt-2" onclick="copyVideoScript()">Copy Video Script</button>
          </div>
        </div>
      </div>
      
      <!-- Toast Notification -->
      <div id="toast">Copied!</div>
      
      <!-- Modals: Add Campaign, Add Ad Set, Add Ad (rimangono invariati) -->
      <!-- Modal: Add Campaign -->
      <div class="modal fade" id="addCampaignModal" tabindex="-1" aria-labelledby="addCampaignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-glass">
            <form id="addCampaignForm">
              <div class="modal-header">
                <h5 class="modal-title" id="addCampaignModalLabel">Add New Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Campaign form fields -->
                <div class="mb-3">
                  <label class="form-label">Campaign Name</label>
                  <input type="text" class="form-control" name="Campaign Name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="Status">
                    <option value="Active">Active</option>
                    <option value="Paused">Paused</option>
                    <option value="Disabled">Disabled</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Budget Spent (€)</label>
                  <input type="number" class="form-control" name="Budget Spent (€)" step="0.01" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Impressions</label>
                  <input type="number" class="form-control" name="Impressions" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Clicks</label>
                  <input type="number" class="form-control" name="Clicks" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">CTR (%)</label>
                  <input type="number" class="form-control" name="CTR (%)" step="0.1">
                </div>
                <div class="mb-3">
                  <label class="form-label">Conversions</label>
                  <input type="number" class="form-control" name="Conversions" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ROAS</label>
                  <input type="number" class="form-control" name="ROAS" step="0.1">
                </div>
                <div class="mb-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" name="Start Date" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" name="End Date" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Add Campaign</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Modal: Add Ad Set -->
      <div class="modal fade" id="addAdSetModal" tabindex="-1" aria-labelledby="addAdSetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-glass">
            <form id="addAdSetForm">
              <div class="modal-header">
                <h5 class="modal-title" id="addAdSetModalLabel">Add New Ad Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Ad Set form fields -->
                <div class="mb-3">
                  <label class="form-label">Ad Set Name</label>
                  <input type="text" class="form-control" name="Ad Set Name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Campaign ID</label>
                  <input type="text" class="form-control" name="Campaign ID" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="Status">
                    <option value="Active">Active</option>
                    <option value="Paused">Paused</option>
                    <option value="Disabled">Disabled</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Targeting Details</label>
                  <input type="text" class="form-control" name="Targeting Details" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Budget</label>
                  <input type="number" class="form-control" name="Budget" step="0.01" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" name="Start Date" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" name="End Date" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Add Ad Set</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Modal: Add Ad -->
      <div class="modal fade" id="addAdModal" tabindex="-1" aria-labelledby="addAdModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-glass">
            <form id="addAdForm">
              <div class="modal-header">
                <h5 class="modal-title" id="addAdModalLabel">Add New Ad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Ad form fields -->
                <div class="mb-3">
                  <label class="form-label">Ad Name</label>
                  <input type="text" class="form-control" name="Ad Name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ad Set ID</label>
                  <input type="text" class="form-control" name="Ad Set ID" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Format</label>
                  <input type="text" class="form-control" name="Format" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ad Copy</label>
                  <input type="text" class="form-control" name="Ad Copy" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Destination URL</label>
                  <input type="text" class="form-control" name="Destination URL" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="Status">
                    <option value="Active">Active</option>
                    <option value="Paused">Paused</option>
                    <option value="Disabled">Disabled</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">CTR (%)</label>
                  <input type="number" class="form-control" name="CTR (%)" step="0.1">
                </div>
                <div class="mb-3">
                  <label class="form-label">Engagement Rate (%)</label>
                  <input type="number" class="form-control" name="Engagement Rate (%)" step="0.1">
                </div>
                <div class="mb-3">
                  <label class="form-label">Clicks</label>
                  <input type="number" class="form-control" name="Clicks" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Conversions</label>
                  <input type="number" class="form-control" name="Conversions" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Add Ad</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <footer class="text-center py-3 mt-4 border-top">
        &copy; 2025 Estateicons AI Campaign Manager. All rights reserved.
      </footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Functions for loading campaigns, ad sets, and ads ---
      function loadCampaigns() {
        google.script.run.withSuccessHandler(renderCampaigns).getMetaCampaigns();
      }
      function renderCampaigns(campaigns) {
        var container = document.getElementById("campaignsContainer");
        if (!campaigns || campaigns.length === 0) {
          container.innerHTML = "<p class='text-center'>No campaigns found.</p>";
          return;
        }
        var headers = Object.keys(campaigns[0]);
        var html = "<table class='table table-bordered table-hover data-table'><thead><tr>";
        headers.forEach(function(header) {
          html += "<th class='pointer' onclick='sortTable(\"campaignsContainer\", \"" + header + "\")'>" + header + "</th>";
        });
        html += "<th>Actions</th></tr></thead><tbody>";
        campaigns.forEach(function(campaign) {
          html += "<tr data-id='" + campaign["Campaign ID"] + "'>";
          headers.forEach(function(header) {
            html += "<td ondblclick='makeEditable(this)'>" + (campaign[header] || "") + "</td>";
          });
          html += "<td>";
          html += "<button class='btn btn-sm btn-primary action-btn' onclick='saveRow(this, \"campaignsContainer\", \"updateMetaCampaign\")'><i class='fas fa-save'></i></button> ";
          html += "<button class='btn btn-sm btn-danger action-btn' onclick='deleteRow(this, \"campaignsContainer\", \"deleteMetaCampaign\")'><i class='fas fa-trash'></i></button>";
          html += "</td></tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
        addSearchFunctionality("searchCampaigns", "campaignsContainer");
      }
      
      function loadAdSets() {
        google.script.run.withSuccessHandler(renderAdSets).getMetaAdSets();
      }
      function renderAdSets(adSets) {
        var container = document.getElementById("adSetsContainer");
        if (!adSets || adSets.length === 0) {
          container.innerHTML = "<p class='text-center'>No ad sets found.</p>";
          return;
        }
        var headers = Object.keys(adSets[0]);
        var html = "<table class='table table-bordered table-hover data-table'><thead><tr>";
        headers.forEach(function(header) {
          html += "<th class='pointer' onclick='sortTable(\"adSetsContainer\", \"" + header + "\")'>" + header + "</th>";
        });
        html += "<th>Actions</th></tr></thead><tbody>";
        adSets.forEach(function(adSet) {
          html += "<tr data-id='" + adSet["Ad Set ID"] + "'>";
          headers.forEach(function(header) {
            html += "<td ondblclick='makeEditable(this)'>" + (adSet[header] || "") + "</td>";
          });
          html += "<td>";
          html += "<button class='btn btn-sm btn-primary action-btn' onclick='saveRow(this, \"adSetsContainer\", \"updateMetaAdSet\")'><i class='fas fa-save'></i></button> ";
          html += "<button class='btn btn-sm btn-danger action-btn' onclick='deleteRow(this, \"adSetsContainer\", \"deleteMetaAdSet\")'><i class='fas fa-trash'></i></button>";
          html += "</td></tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
        addSearchFunctionality("searchAdSets", "adSetsContainer");
      }
      
      function loadAds() {
        google.script.run.withSuccessHandler(renderAds).getMetaAds();
      }
      function renderAds(ads) {
        var container = document.getElementById("adsContainer");
        if (!ads || ads.length === 0) {
          container.innerHTML = "<p class='text-center'>No ads found.</p>";
          return;
        }
        var headers = Object.keys(ads[0]);
        var html = "<table class='table table-bordered table-hover data-table'><thead><tr>";
        headers.forEach(function(header) {
          html += "<th class='pointer' onclick='sortTable(\"adsContainer\", \"" + header + "\")'>" + header + "</th>";
        });
        html += "<th>Actions</th></tr></thead><tbody>";
        ads.forEach(function(ad) {
          html += "<tr data-id='" + ad["Ad ID"] + "'>";
          headers.forEach(function(header) {
            html += "<td ondblclick='makeEditable(this)'>" + (ad[header] || "") + "</td>";
          });
          html += "<td>";
          html += "<button class='btn btn-sm btn-primary action-btn' onclick='saveRow(this, \"adsContainer\", \"updateMetaAd\")'><i class='fas fa-save'></i></button> ";
          html += "<button class='btn btn-sm btn-danger action-btn' onclick='deleteRow(this, \"adsContainer\", \"deleteMetaAd\")'><i class='fas fa-trash'></i></button>";
          html += "</td></tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
        addSearchFunctionality("searchAds", "adsContainer");
      }
      
      function makeEditable(cell) {
        cell.contentEditable = true;
        cell.classList.add("editable");
        cell.focus();
      }
      
      function saveRow(button, containerId, updateFunction) {
        var row = button.closest("tr");
        var id = row.getAttribute("data-id");
        var headerCells = row.closest("table").querySelectorAll("thead th");
        var dataCells = row.querySelectorAll("td");
        var updatedData = {};
        for (var i = 0; i < headerCells.length - 1; i++) {
          var header = headerCells[i].textContent.trim();
          updatedData[header] = dataCells[i].textContent.trim();
        }
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
          dataCells.forEach(function(cell) {
            cell.contentEditable = false;
            cell.classList.remove("editable");
          });
          if (containerId === "campaignsContainer") loadCampaigns();
          else if (containerId === "adSetsContainer") loadAdSets();
          else if (containerId === "adsContainer") loadAds();
        }).withFailureHandler(function(error) {
          alert("Error: " + error);
        })[updateFunction](id, updatedData);
      }
      
      function deleteRow(button, containerId, deleteFunction) {
        if (!confirm("Are you sure you want to delete this item?")) return;
        var row = button.closest("tr");
        var id = row.getAttribute("data-id");
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
          if (containerId === "campaignsContainer") loadCampaigns();
          else if (containerId === "adSetsContainer") loadAdSets();
          else if (containerId === "adsContainer") loadAds();
        }).withFailureHandler(function(error) {
          alert("Error: " + error);
        })[deleteFunction](id);
      }
      
      var sortDirection = {};
      function sortTable(containerId, headerName) {
        var container = document.getElementById(containerId);
        var table = container.querySelector("table");
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));
        sortDirection[headerName] = sortDirection[headerName] === "asc" ? "desc" : "asc";
        rows.sort(function(a, b) {
          var idx = getHeaderIndex(headerName, table);
          var cellA = a.querySelectorAll("td")[idx].textContent.trim();
          var cellB = b.querySelectorAll("td")[idx].textContent.trim();
          if (!isNaN(cellA) && !isNaN(cellB)) {
            return sortDirection[headerName] === "asc" ? cellA - cellB : cellB - cellA;
          } else {
            return sortDirection[headerName] === "asc" ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
          }
        });
        tbody.innerHTML = "";
        rows.forEach(function(row) {
          tbody.appendChild(row);
        });
      }
      
      function getHeaderIndex(headerName, table) {
        var headers = table.querySelectorAll("thead th");
        for (var i = 0; i < headers.length; i++) {
          if (headers[i].textContent.trim() === headerName) return i;
        }
        return -1;
      }
      
      function addSearchFunctionality(searchInputId, containerId) {
        var input = document.getElementById(searchInputId);
        input.addEventListener("keyup", function() {
          var filter = input.value.toUpperCase();
          var container = document.getElementById(containerId);
          var rows = container.getElementsByTagName("tr");
          for (var i = 1; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName("td");
            var visible = false;
            for (var j = 0; j < cells.length - 1; j++) {
              if (cells[j] && cells[j].textContent.toUpperCase().indexOf(filter) > -1) {
                visible = true;
                break;
              }
            }
            rows[i].style.display = visible ? "" : "none";
          }
        });
      }
      
      function uploadFile() {
        var fileInput = document.getElementById("fileUpload");
        var csvType = document.getElementById("csvType").value;
        var file = fileInput.files[0];
        if (!file) {
          alert("Please select a CSV file.");
          return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          var csvData = e.target.result;
          google.script.run.withSuccessHandler(function(response) {
            alert(response);
            loadCampaigns();
            loadAdSets();
            loadAds();
          }).processCSVUpload(csvData, csvType);
        };
        reader.readAsText(file);
      }
      
      // ANALYSIS: Load analysis data and update dashboard and charts
      function loadAnalysis() {
        google.script.run.withSuccessHandler(renderAnalysis).analyzeData();
      }
      
      function renderAnalysis(analysis) {
        if (analysis.campaigns) {
          document.getElementById("totalBudget").textContent = "€" + analysis.campaigns.totalBudget;
          document.getElementById("totalConversions").textContent = analysis.campaigns.totalConversions;
          document.getElementById("avgCTR").textContent = analysis.campaigns.averageCTR + "%";
          document.getElementById("avgCPA").textContent = analysis.campaigns.averageCPA;
          document.getElementById("avgROAS").textContent = analysis.campaigns.averageROAS;
          document.getElementById("conversionRate").textContent = analysis.campaigns.conversionRate + "%";
          document.getElementById("campaignSuggestion").textContent = analysis.campaigns.suggestion;
        }
        if (analysis.adSets) {
          document.getElementById("adSetTotalBudget").textContent = "€" + analysis.adSets.totalBudget;
          document.getElementById("adSetAvgBudget").textContent = analysis.adSets.averageBudget;
          document.getElementById("adSetAvgDailyBudget").textContent = analysis.adSets.averageDailyBudget;
          document.getElementById("adSetSuggestion").textContent = analysis.adSets.suggestion;
        }
        if (analysis.ads) {
          document.getElementById("adsTotalClicks").textContent = analysis.ads.totalClicks;
          document.getElementById("adsTotalConversions").textContent = analysis.ads.totalConversions;
          document.getElementById("adsAvgCTR").textContent = analysis.ads.averageCTR + "%";
          document.getElementById("adsAvgEngagement").textContent = analysis.ads.averageEngagement + "%";
          document.getElementById("adsConversionRate").textContent = analysis.ads.conversionRate + "%";
          document.getElementById("adsSuggestion").textContent = analysis.ads.suggestion;
        }
        renderCampaignChart(analysis.campaigns);
        renderAdsChart(analysis.ads);
      }
      
      function renderCampaignChart(campaignData) {
        var ctx = document.getElementById("campaignChart").getContext("2d");
        var labels = ["Avg CTR (%)", "Avg ROAS"];
        var dataValues = [];
        if (campaignData && campaignData.averageCTR !== "N/A") {
          dataValues.push(parseFloat(campaignData.averageCTR));
        } else { dataValues.push(0); }
        if (campaignData && campaignData.averageROAS !== "N/A") {
          dataValues.push(parseFloat(campaignData.averageROAS));
        } else { dataValues.push(0); }
        if (window.campaignChartInstance) {
          window.campaignChartInstance.destroy();
        }
        window.campaignChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Campaign KPIs',
              data: dataValues,
              backgroundColor: ["rgba(67,97,238,0.8)", "rgba(67,97,238,0.8)"],
              borderColor: ["rgba(67,97,238,1)", "rgba(67,97,238,1)"],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
      
      function renderAdsChart(adsData) {
        var ctx = document.getElementById("adsChart").getContext("2d");
        var labels = ["Avg CTR (%)", "Avg Engagement (%)"];
        var dataValues = [];
        if (adsData && adsData.averageCTR !== "N/A") {
          dataValues.push(parseFloat(adsData.averageCTR));
        } else { dataValues.push(0); }
        if (adsData && adsData.averageEngagement !== "N/A") {
          dataValues.push(parseFloat(adsData.averageEngagement));
        } else { dataValues.push(0); }
        if (window.adsChartInstance) {
          window.adsChartInstance.destroy();
        }
        window.adsChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Ads Performance',
              data: dataValues,
              backgroundColor: ["rgba(14,165,233,0.8)", "rgba(20,184,166,0.8)"],
              borderColor: ["rgba(14,165,233,1)", "rgba(20,184,166,1)"],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
      
      // Load preformatted campaign scripts into the Campaign Scripts tab
      function loadCampaignScripts() {
        google.script.run.withSuccessHandler(function(html) {
          document.getElementById("campaignScriptsContainer").innerHTML = html;
        }).getCampaignScripts();
      }
      
      // Copy all preformatted campaign scripts to clipboard
      function copyAllCampaignScripts() {
        var container = document.getElementById("campaignScriptsContainer");
        var text = container.innerText;
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(function() {
            showToast("Campaign scripts copied to clipboard!");
          }, function(err) {
            alert("Error copying text: " + err);
          });
        } else {
          var tempTextarea = document.createElement("textarea");
          tempTextarea.value = text;
          document.body.appendChild(tempTextarea);
          tempTextarea.select();
          document.execCommand("copy");
          document.body.removeChild(tempTextarea);
          showToast("Campaign scripts copied to clipboard!");
        }
      }
      
      // AI Generation: Generate textual campaign script via ChatGPT based on user parameters
      function generateAICampaignScript() {
        var campaignType = document.getElementById("campaignTypeAI").value;
        var city = document.getElementById("city").value;
        var budget = document.getElementById("budget").value;
        var agentName = document.getElementById("agentName").value;
        var tone = document.getElementById("tone").value;
        
        if (!campaignType || !city || !budget || !agentName || !tone) {
          alert("Please fill in all fields for AI generation.");
          return;
        }
        
        document.getElementById("aiCampaignOutput").innerHTML = "<em>Generating AI campaign script... Please wait.</em>";
        
        google.script.run.withSuccessHandler(function(response) {
          document.getElementById("aiCampaignOutput").innerHTML = "<h5>Generated Campaign Script</h5><pre>" + response.replace(/\n/g, "<br>") + "</pre>";
        }).generateCampaignScript(campaignType, city, budget, agentName);
      }
      
      // AI Generation: Generate video campaign script via ChatGPT based on user parameters
      function generateVideoScript() {
        var videoType = document.getElementById("videoType").value;
        var city = document.getElementById("videoCity").value;
        var agentName = document.getElementById("videoAgentName").value;
        var tone = document.getElementById("videoTone").value;
        
        if (!videoType || !city || !agentName || !tone) {
          alert("Please fill in all fields for video campaign generation.");
          return;
        }
        
        document.getElementById("videoCampaignOutput").innerHTML = "<em>Generating video campaign script... Please wait.</em>";
        
        google.script.run.withSuccessHandler(function(response) {
          document.getElementById("videoCampaignOutput").innerHTML = "<h5>Generated Video Campaign Script</h5><pre>" + response.replace(/\n/g, "<br>") + "</pre>";
        }).generateVideoCampaignScript(videoType, city, agentName, tone);
      }
      
      // Copy video campaign script to clipboard
      function copyVideoScript() {
        var text = document.getElementById("videoCampaignOutput").innerText;
        navigator.clipboard.writeText(text).then(function() {
          alert("Video campaign script copied to clipboard!");
        }).catch(function(err) {
          alert("Error copying text: " + err);
        });
      }
      
      // Toast notification
      function showToast(message) {
        var toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(function() {
          toast.classList.remove("show");
        }, 3000);
      }
      
      // Functions to show modals
      function showAddCampaignModal() {
        new bootstrap.Modal(document.getElementById('addCampaignModal')).show();
      }
      function showAddAdSetModal() {
        new bootstrap.Modal(document.getElementById('addAdSetModal')).show();
      }
      function showAddAdModal() {
        new bootstrap.Modal(document.getElementById('addAdModal')).show();
      }
      
      // Form submission handling
      document.getElementById("addCampaignForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var formData = new FormData(e.target);
        var campaignData = {};
        formData.forEach(function(value, key) { campaignData[key] = value; });
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
          new bootstrap.Modal(document.getElementById('addCampaignModal')).hide();
          e.target.reset();
          loadCampaigns();
        }).addMetaCampaign(campaignData);
      });
      
      document.getElementById("addAdSetForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var formData = new FormData(e.target);
        var adSetData = {};
        formData.forEach(function(value, key) { adSetData[key] = value; });
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
          new bootstrap.Modal(document.getElementById('addAdSetModal')).hide();
          e.target.reset();
          loadAdSets();
        }).addMetaAdSet(adSetData);
      });
      
      document.getElementById("addAdForm").addEventListener("submit", function(e) {
        e.preventDefault();
        var formData = new FormData(e.target);
        var adData = {};
        formData.forEach(function(value, key) { adData[key] = value; });
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
          new bootstrap.Modal(document.getElementById('addAdModal')).hide();
          e.target.reset();
          loadAds();
        }).addMetaAd(adData);
      });
      
      // Load campaign scripts when the Campaign Scripts tab is activated
      var campaignScriptsTab = document.querySelector('[data-bs-target="#campaignScripts"]');
      campaignScriptsTab.addEventListener('shown.bs.tab', loadCampaignScripts);
      
      window.onload = function() {
        loadCampaigns();
      };
    </script>
  </body>
</html>
